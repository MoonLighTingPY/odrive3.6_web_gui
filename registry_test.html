<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODrive Registry Version Detection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007acc;
            background-color: #f8f9fa;
        }
        .success { border-left-color: #28a745; }
        .warning { border-left-color: #ffc107; }
        .error { border-left-color: #dc3545; }
        
        button {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #005a9e; }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #e9ecef;
        }
        
        .version-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .v056 { background-color: #28a745; color: white; }
        .v0611 { background-color: #007acc; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß ODrive Registry Version Detection Test</h1>
        <p>This page demonstrates the automatic firmware version detection and registry switching system.</p>
        
        <div class="test-section">
            <h3>Current Status</h3>
            <p>Current Registry Version: <span id="current-version" class="version-badge">Loading...</span></p>
            <p>Registry Instance ID: <span id="registry-id">Loading...</span></p>
            <p>Available Registries: <span id="available-registries">Loading...</span></p>
        </div>

        <div class="test-section">
            <h3>Manual Version Testing</h3>
            <p>Test different firmware versions to see registry switching:</p>
            <button onclick="testVersion('v0.5.6')">Test v0.5.6</button>
            <button onclick="testVersion('v0.6.11')">Test v0.6.11</button>
            <button onclick="testVersion('v0.6.0')">Test v0.6.0</button>
            <button onclick="testVersion('v0.5.3')">Test v0.5.3</button>
            <button onclick="testVersion('invalid')">Test Invalid Version</button>
            <button onclick="runComparisonTest()">Compare All Versions</button>
        </div>

        <div class="test-section">
            <h3>Registry Information</h3>
            <pre id="registry-info">Click a test button to see registry details...</pre>
        </div>

        <div class="test-section">
            <h3>Test Results</h3>
            <div id="test-results">No tests run yet.</div>
        </div>

        <div class="test-section warning">
            <h3>‚ö†Ô∏è Integration Test</h3>
            <p>To test with a real ODrive device:</p>
            <ol>
                <li>Connect an ODrive device</li>
                <li>Open the main application</li>
                <li>Check the "FW:" badge in the device list</li>
                <li>Verify the registry matches the firmware version</li>
            </ol>
        </div>
    </div>

    <script type="module">
        // Mock registry manager for testing (simplified version)
        class MockRegistryManager {
            constructor() {
                this.registries = new Map();
                this.currentVersion = null;
                this.currentRegistry = null;
            }

            parseVersion(versionString) {
                if (!versionString || typeof versionString !== 'string') {
                    return '0.5.6';
                }
                
                const cleanVersion = versionString.replace(/^v/, '');
                const parts = cleanVersion.split('.').map(Number);
                
                const major = parts[0] || 0;
                const minor = parts[1] || 5;
                
                if (major === 0 && minor >= 6) {
                    return '0.6.11';
                }
                
                return '0.5.6';
            }

            createMockRegistry(version) {
                const isV06x = version === '0.6.11';
                return {
                    firmwareVersion: version,
                    configCategories: {
                        power: isV06x ? ['param1', 'param2', 'param3'] : ['param1', 'param2'],
                        motor: isV06x ? ['param4', 'param5', 'param6', 'param7'] : ['param4', 'param5'],
                        encoder: ['param8', 'param9'],
                        control: isV06x ? ['param10', 'param11', 'param12'] : ['param10', 'param11'],
                        interface: ['param13', 'param14']
                    },
                    versionSpecificProps: isV06x ? [
                        'bootloader_version', 'control_loop_hz', 'test_property', 'identify'
                    ] : [
                        'brake_resistor_armed', 'brake_resistor_saturated', 'brake_resistor_current'
                    ]
                };
            }

            setCurrentVersion(versionString) {
                const normalizedVersion = this.parseVersion(versionString);
                
                if (this.currentVersion !== normalizedVersion) {
                    console.log(`Switching registry from ${this.currentVersion} to ${normalizedVersion}`);
                    this.currentVersion = normalizedVersion;
                    this.currentRegistry = this.createMockRegistry(normalizedVersion);
                }
            }

            getCurrentRegistry() {
                if (!this.currentRegistry) {
                    this.currentRegistry = this.createMockRegistry('0.5.6');
                    this.currentVersion = '0.5.6';
                }
                return this.currentRegistry;
            }

            getDebugInfo() {
                return {
                    currentVersion: this.currentVersion,
                    availableRegistries: Array.from(this.registries.keys()),
                    registryCacheSize: this.registries.size,
                    hasCurrentRegistry: !!this.currentRegistry
                };
            }
        }

        // Initialize test system
        const mockRegistryManager = new MockRegistryManager();
        
        function updateStatus() {
            const registry = mockRegistryManager.getCurrentRegistry();
            const debugInfo = mockRegistryManager.getDebugInfo();
            
            document.getElementById('current-version').textContent = debugInfo.currentVersion || 'None';
            document.getElementById('current-version').className = `version-badge ${debugInfo.currentVersion === '0.5.6' ? 'v056' : 'v0611'}`;
            
            document.getElementById('registry-id').textContent = registry.firmwareVersion || 'None';
            document.getElementById('available-registries').textContent = debugInfo.availableRegistries.length || '0';
        }

        function displayRegistryInfo(registry) {
            const info = {
                firmwareVersion: registry.firmwareVersion,
                categories: Object.keys(registry.configCategories),
                parameterCounts: Object.fromEntries(
                    Object.entries(registry.configCategories).map(([cat, params]) => [cat, params.length])
                ),
                versionSpecificProperties: registry.versionSpecificProps,
                totalParameters: Object.values(registry.configCategories).reduce((sum, params) => sum + params.length, 0)
            };
            
            document.getElementById('registry-info').textContent = JSON.stringify(info, null, 2);
        }

        window.testVersion = function(version) {
            console.log(`Testing version: ${version}`);
            
            try {
                mockRegistryManager.setCurrentVersion(version);
                const registry = mockRegistryManager.getCurrentRegistry();
                
                updateStatus();
                displayRegistryInfo(registry);
                
                const resultDiv = document.getElementById('test-results');
                resultDiv.innerHTML += `
                    <div class="test-section success">
                        <strong>‚úÖ ${version}</strong> ‚Üí Registry: ${registry.firmwareVersion}
                        (${Object.values(registry.configCategories).reduce((sum, params) => sum + params.length, 0)} parameters)
                    </div>
                `;
            } catch (error) {
                const resultDiv = document.getElementById('test-results');
                resultDiv.innerHTML += `
                    <div class="test-section error">
                        <strong>‚ùå ${version}</strong> ‚Üí Error: ${error.message}
                    </div>
                `;
            }
        }

        window.runComparisonTest = function() {
            console.log('Running comparison test...');
            
            // Test v0.5.6
            mockRegistryManager.setCurrentVersion('v0.5.6');
            const v056Registry = mockRegistryManager.getCurrentRegistry();
            const v056Count = Object.values(v056Registry.configCategories).reduce((sum, params) => sum + params.length, 0);
            
            // Test v0.6.11
            mockRegistryManager.setCurrentVersion('v0.6.11');
            const v0611Registry = mockRegistryManager.getCurrentRegistry();
            const v0611Count = Object.values(v0611Registry.configCategories).reduce((sum, params) => sum + params.length, 0);
            
            const diff = v0611Count - v056Count;
            
            const resultDiv = document.getElementById('test-results');
            resultDiv.innerHTML += `
                <div class="test-section warning">
                    <h4>üìä Version Comparison Results</h4>
                    <p><span class="version-badge v056">v0.5.6</span> Parameters: ${v056Count}</p>
                    <p><span class="version-badge v0611">v0.6.11</span> Parameters: ${v0611Count}</p>
                    <p><strong>Difference: ${diff > 0 ? '+' : ''}${diff} parameters</strong></p>
                    <p>v0.5.6 specific: ${v056Registry.versionSpecificProps.join(', ')}</p>
                    <p>v0.6.11 specific: ${v0611Registry.versionSpecificProps.join(', ')}</p>
                </div>
            `;
            
            updateStatus();
            displayRegistryInfo(v0611Registry);
        }

        // Initialize display
        updateStatus();
        displayRegistryInfo(mockRegistryManager.getCurrentRegistry());

        console.log('üîß ODrive Registry Version Detection Test System Loaded');
        console.log('Available functions: testVersion(), runComparisonTest()');
    </script>
</body>
</html>